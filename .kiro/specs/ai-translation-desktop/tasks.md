# 実装タスク: ai-translation-desktop

## タスク概要

- **機能名**: AI Translation Desktop
- **総タスク数**: 9メジャータスク、26サブタスク
- **要件カバレッジ**: 9要件すべてをカバー
- **完了状況**: Phase 1-9完了（統合テスト8.3を除く）
- **ビルド結果**:
  - アプリサイズ: 4.8MB（要件50MB以下を達成）
  - テスト: フロントエンド69テスト、バックエンド26テストすべてパス

---

## Phase 1: プロジェクトセットアップ

- [x] 1. Tauri v2プロジェクトの初期化と基本設定 ✅

- [x] 1.1 (P) Tauri v2プロジェクトを作成し、React + TypeScript テンプレートで初期化する ✅
  - プロジェクト名を設定しTauri CLIで新規プロジェクトを生成
  - Vite + React + TypeScript構成を選択
  - Tailwind CSSを追加しスタイリング環境を構築
  - `npm run tauri dev`で開発サーバーが起動することを確認
  - _Requirements: 9.6_

- [x] 1.2 (P) Rust側の依存関係を追加し、基本的なプラグイン構成を設定する ✅
  - `Cargo.toml`に必要なクレート（reqwest, serde, tokio, thiserror）を追加
  - Tauriプラグイン（global-shortcut, clipboard-manager, store）を設定
  - macOS権限プラグイン（tauri-plugin-macos-permissions）を追加
  - ビルドが成功することを確認
  - _Requirements: 9.6, 9.8_

- [x] 1.3 TypeScriptのパスエイリアスと型定義を設定する ✅
  - `@/`エイリアスをsrcディレクトリにマッピング
  - ESLint + Prettierの設定を追加
  - strict modeを有効化し、`any`型の使用を禁止
  - _Requirements: 9.8_

---

## Phase 2: バックエンド基盤実装

- [x] 2. Rustバックエンドのコア機能を実装する ✅

- [x] 2.1 設定管理機能を実装し、アプリケーション設定を永続化できるようにする ✅
  - tauri-plugin-storeを使用してJSON形式で設定を保存
  - デフォルト設定（ショートカット、LLMプロバイダー、Ollamaモデル）を定義
  - 設定の読み込み・保存・リセット機能を実装
  - アプリ起動時に保存済み設定を自動読み込み
  - _Requirements: 8.1, 8.2_
  - _Contracts: SettingsService_

- [x] 2.2 (P) APIキーをmacOS Keychainに安全に保存・取得する機能を実装する ✅
  - security-frameworkクレートを使用してKeychainにアクセス
  - service名とaccount名を定数として定義
  - APIキーの保存・取得・削除機能を実装
  - 未署名アプリ時のフォールバック処理を追加
  - _Requirements: 8.7, 9.4_
  - _Contracts: KeychainService_

- [x] 2.3 設定管理とKeychain管理をTauri IPCコマンドとして公開する ✅
  - `get_settings`、`save_settings`、`reset_settings`コマンドを実装
  - `save_api_key`、`get_api_key`、`delete_api_key`コマンドを実装
  - フロントエンドから呼び出し可能な形でエクスポート
  - _Requirements: 8.1, 8.2, 8.7_

---

## Phase 3: LLM翻訳機能実装

- [x] 3. Ollama APIを使用した翻訳機能を実装する ✅

- [x] 3.1 (P) Ollama APIクライアントを実装し、ローカルLLMで翻訳できるようにする ✅
  - reqwestを使用して`localhost:11434/api/chat`エンドポイントに接続
  - 翻訳用プロンプトを構築し、翻訳結果のみを抽出
  - 60秒タイムアウトを設定
  - Ollama接続状態の確認機能を実装
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 7.2, 7.4_

- [x] 3.2 翻訳サービスを統合し、Ollama翻訳を実装する ✅
  - 設定に基づいてOllamaエンドポイントとモデルを使用
  - 翻訳リクエストをOllama APIに送信
  - 翻訳結果に所要時間を含める
  - Tauri IPCコマンド（`translate`、`check_provider_status`、`preload_ollama_model`）として公開
  - _Requirements: 4.1, 7.1, 7.5, 9.1_
  - _Contracts: TranslationService_

---

## Phase 4: システム機能実装

- [x] 4. グローバルショートカットとクリップボード操作を実装する ✅

- [x] 4.1 (P) グローバルショートカットを登録し、システム全体でホットキーを監視する ✅
  - tauri-plugin-global-shortcutを使用してショートカットを登録
  - デフォルト（Cmd+J）とカスタムショートカットに対応
  - ショートカット登録・解除・確認機能を実装
  - 競合検出時のユーザー通知機能を追加
  - _Requirements: 1.1, 1.2, 1.3, 1.4_
  - _Contracts: ShortcutService_

- [x] 4.2 macOSアクセシビリティ権限の確認とリクエスト機能を実装する ✅
  - tauri-plugin-macos-permissionsを使用して権限状態を確認
  - 初回起動時に権限リクエストダイアログを表示
  - 権限が許可されていない場合の警告表示を実装
  - _Requirements: 1.5, 9.7_

- [x] 4.3 (P) クリップボード操作機能を実装し、選択テキストを取得できるようにする ✅
  - tauri-plugin-clipboard-managerを使用してクリップボードを操作
  - 元のクリップボード内容を保存し、処理後に復元
  - Cmd+Cキーストローク送信後にクリップボードを読み取り
  - 空クリップボードや非テキストデータのエラー処理を実装
  - _Requirements: 2.1, 2.2, 2.3, 2.4_
  - _Contracts: ClipboardService_

- [x] 4.4 ショートカットイベントからクリップボード取得、翻訳実行までのフローを連携する ✅
  - ショートカット検出時にクリップボード取得をトリガー
  - 取得したテキストをフロントエンドにIPCイベントで送信
  - エラー発生時の適切なフィードバック処理を実装
  - _Requirements: 1.1, 2.1, 2.2_

---

## Phase 5: フロントエンド基盤実装

- [x] 5. React フロントエンドの基盤コンポーネントとHooksを実装する ✅

- [x] 5.1 (P) 言語検出ライブラリを実装し、テキストの言語を自動判定できるようにする ✅
  - 日本語文字（ひらがな、カタカナ、漢字）の検出ロジックを実装
  - 信頼度スコアを算出し、低信頼度時のデフォルト動作を定義
  - 短いテキスト（10文字未満）でも推測可能にする
  - 純粋関数として実装し、単体テストを追加
  - _Requirements: 3.1, 3.4, 3.5_

- [x] 5.2 (P) 設定管理Hookを実装し、フロントエンドから設定を操作できるようにする ✅
  - Tauri IPCを使用して設定の読み込み・保存を行う
  - 設定変更時の状態管理とエラーハンドリングを実装
  - _Requirements: 8.1, 8.2_

- [x] 5.3 翻訳Hookを実装し、言語検出から翻訳結果取得までのフローを管理する ✅
  - 言語検出を実行し、翻訳方向を自動決定
  - Tauri IPCを使用してバックエンドの翻訳サービスを呼び出し
  - ローディング状態、翻訳結果、エラー状態を管理
  - リセット機能を実装
  - _Requirements: 3.1, 3.2, 3.3, 4.1_

---

## Phase 6: UI コンポーネント実装

- [x] 6. 翻訳ポップアップと設定画面のUIコンポーネントを実装する ✅

- [x] 6.1 翻訳結果を表示するポップアップコンポーネントを実装する ✅
  - ローディング状態、翻訳結果、エラー状態の表示切り替え
  - タイトルバーなしの角丸デザインで実装
  - Tailwind CSSを使用したスタイリング
  - 画面外表示防止のための位置調整ロジックを追加
  - _Requirements: 5.5, 5.6_

- [x] 6.2 ポップアップの表示位置とウィンドウ設定を実装する ✅
  - Tauri window APIを使用してalways_on_top、decorations、skip_taskbarを設定
  - マウスカーソル位置近くにポップアップを表示
  - Dockに表示されないよう設定
  - _Requirements: 5.1, 5.2, 5.7_

- [x] 6.3 ポップアップの閉じる動作を実装する ✅
  - Escキー押下で即座に閉じる
  - ポップアップ外クリックで自動的に閉じる
  - キーボードイベントとクリックイベントのリスナーを設定
  - _Requirements: 5.3, 5.4_

- [x] 6.4 コピーボタンとコピー完了フィードバックを実装する ✅
  - コピーボタンのクリックで翻訳結果をクリップボードにコピー
  - Cmd+Cキーボードショートカットにも対応
  - コピー成功時にチェックマークアイコンを表示
  - コピー後もポップアップは閉じない
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [x] 6.5 (P) 設定画面コンポーネントを実装する ✅
  - ショートカットキーのカスタマイズ入力フィールド
  - Ollamaモデル名・エンドポイント設定
  - Ollama接続テストボタン
  - _Requirements: 8.3, 8.4, 8.5, 7.1_

---

## Phase 7: アプリケーション統合

- [x] 7. 全コンポーネントを統合し、エンドツーエンドの翻訳フローを完成させる ✅

- [x] 7.1 Appコンポーネントでポップアップと設定画面を統合する ✅
  - ショートカットイベントを受信してポップアップを表示
  - 設定画面との切り替えUIを実装
  - グローバル状態の管理
  - _Requirements: 1.1, 5.1_

- [x] 7.2 バックエンドイベントとフロントエンドの連携を実装する ✅
  - Tauri IPCイベント（テキスト取得、翻訳完了、エラー）のリスナーを設定
  - イベント受信時に適切なUI更新を実行
  - エラーメッセージを日本語で表示
  - _Requirements: 2.2, 4.4, 4.5_

- [x] 7.3 アプリ起動時の初期化処理を実装する ✅
  - 設定の読み込みとショートカット登録
  - アクセシビリティ権限の確認
  - Ollamaの接続状態確認とモデルプリロード
  - _Requirements: 8.2, 1.5, 7.2, 7.3_

---

## Phase 8: テストと品質保証

- [x] 8. 単体テスト、統合テストを実装し、品質を担保する ✅

- [x] 8.1 (P) フロントエンドの単体テストを実装する ✅
  - 言語検出ロジックの境界値テストと短文テスト（23テスト）
  - Hooksのモックテスト（useClipboard: 10テスト、useShortcut: 11テスト、usePermissions: 7テスト、useTranslation: 9テスト、useTranslationFlow: 9テスト）
  - すべてのテストがパス
  - _Requirements: 3.1, 3.4, 3.5_

- [x] 8.2 (P) バックエンドの単体テストを実装する ✅
  - 翻訳プロンプト構築のテスト
  - 言語シリアライゼーションのテスト
  - 設定管理のテスト
  - エラーハンドリングのテスト
  - 26テストすべてパス
  - _Requirements: 4.6, 8.1, 8.2_

- [ ] 8.3 統合テストを実装する（オプショナル）
  - ショートカット→クリップボード→翻訳のE2Eフロー
  - 設定変更→Ollama設定更新の動作確認
  - エラー発生時のユーザーフィードバック確認
  - _Requirements: 1.1, 2.1, 4.1, 7.1_

---

## Phase 9: 最終調整とビルド

- [x] 9. パフォーマンス最適化と本番ビルドの準備を行う ✅

- [x] 9.1 パフォーマンス要件を確認し、必要に応じて最適化する ✅
  - 翻訳タイムアウト60秒に設定（Ollama使用時）
  - Ollamaモデルプリロード機能を実装（初回翻訳の高速化）
  - 起動時設定読み込みの最適化
  - _Requirements: 9.1, 9.2_

- [x] 9.2 本番ビルドを作成し、アプリサイズと動作を確認する ✅
  - `npm run tauri build`でプロダクションビルドを実行完了
  - アプリサイズ: 4.8MB（要件50MB以下を大幅にクリア）
  - バイナリサイズ: 4.7MB
  - DMGパッケージ: 2.4MB
  - macOS arm64アーキテクチャ対応
  - _Requirements: 9.6, 9.8_

- [x] 9.3 オフライン動作とセキュリティを最終確認する ✅
  - Ollama専用実装によりオフライン動作を実現
  - エラーハンドリングが適切に実装済み
  - ローカル処理によりプライバシー保護
  - _Requirements: 9.3, 9.5_

---

## 要件カバレッジマトリクス

| 要件 | タスク |
|------|--------|
| 1.1-1.5 | 4.1, 4.2, 4.4, 7.1, 7.3 |
| 2.1-2.4 | 4.3, 4.4, 7.2 |
| 3.1-3.5 | 5.1, 5.3, 8.1 |
| 4.1-4.6 | 3.1, 3.2, 3.3, 8.2, 8.3 |
| 5.1-5.7 | 6.1, 6.2, 6.3, 7.1 |
| 6.1-6.4 | 6.4 |
| 7.1-7.5 | 3.1, 3.2, 3.3, 6.5, 7.3 |
| 8.1-8.7 | 2.1, 2.2, 2.3, 5.2, 6.5, 8.2 |
| 9.1-9.8 | 1.1, 1.2, 1.3, 4.2, 9.1, 9.2, 9.3 |
