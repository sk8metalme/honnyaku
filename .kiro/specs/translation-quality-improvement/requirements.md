# Requirements Document

## Project Description (Input)
Claude CLI翻訳の品質を改善するため、システムプロンプトを最適化する。現在の翻訳品質スコア50/100を80/100以上に向上させることを目標とする。具体的には、文脈理解の向上、専門用語の適切な翻訳、自然な表現の生成を実現する。翻訳システムプロンプトに以下の要素を追加・改善する: 1) 技術文書に特化した翻訳ルール、2) コンテキスト保持のための指示、3) 専門用語辞書の活用、4) 自然な表現への変換ガイドライン。

## Introduction

Honnyaku翻訳アプリケーションのClaude CLI翻訳機能において、システムプロンプトを最適化することで翻訳品質を向上させます。現在の翻訳品質スコア50/100を80/100以上に改善することを目標とし、技術文書に特化した翻訳ルール、コンテキスト保持機能、専門用語辞書の活用、自然な表現変換ガイドラインを導入します。

この改善により、開発者が技術ドキュメントを翻訳する際の精度と自然さが向上し、翻訳結果の品質が実用レベルに到達します。

## Requirements

### Requirement 1: システムプロンプト構造の最適化

**Objective:** アプリケーション開発者として、Claude CLI翻訳のシステムプロンプトを構造化して最適化し、翻訳品質を向上させたい

#### Acceptance Criteria

1. When システムプロンプトを構築する際、the Honnyakuアプリ shall 翻訳タスクの明確な定義、コンテキスト保持の指示、品質基準を含む構造化されたプロンプトを生成する
2. The Honnyakuアプリ shall システムプロンプトを役割定義セクション、翻訳ルールセクション、品質ガイドラインセクションの3つのセクションに分割して構成する
3. When プロンプトキャッシングを活用する場合、the Honnyakuアプリ shall システムプロンプトの固定部分（翻訳ルール、ガイドライン）を最大1024トークンのキャッシュブロックとして構成する
4. The Honnyakuアプリ shall システムプロンプトに「あなたはプロフェッショナルな技術翻訳者です」という明確な役割定義を含める
5. When 翻訳方向（英語→日本語、日本語→英語）を指定する場合、the Honnyakuアプリ shall システムプロンプトに翻訳元言語と翻訳先言語を明示的に記述する

### Requirement 2: 技術文書特化型翻訳ルールの実装

**Objective:** ユーザーとして、技術文書や開発関連テキストの翻訳精度を向上させ、専門用語が適切に翻訳されるようにしたい

#### Acceptance Criteria

1. The Honnyakuアプリ shall システムプロンプトに技術文書特化型の翻訳ルールを含める（プログラミング用語の保持、APIドキュメントの構造保持、コードスニペットの非翻訳化）
2. When プログラミング言語のキーワードや識別子を検出した場合、the Honnyakuアプリ shall それらを原文のまま保持するようシステムプロンプトで指示する
3. When コードブロック（バッククォート3つで囲まれた部分）を検出した場合、the Honnyakuアプリ shall コード部分を翻訳せず原文のまま保持するようシステムプロンプトで指示する
4. The Honnyakuアプリ shall システムプロンプトにAPIエンドポイント、HTTPメソッド、ファイルパス、コマンドライン引数を原文のまま保持する指示を含める
5. When 技術用語の日本語訳が複数存在する場合（例: "cache" → "キャッシュ" vs "キャッシ"）、the Honnyakuアプリ shall 一貫性のある訳語選択ルールをシステムプロンプトで指定する
6. The Honnyakuアプリ shall システムプロンプトに「開発者向けドキュメントの翻訳では、技術的な正確性を最優先し、意訳よりも直訳を重視する」という指示を含める

### Requirement 3: コンテキスト保持機能の実装

**Objective:** アプリケーション開発者として、翻訳時に文脈情報を保持し、前後の文との整合性を維持したい

#### Acceptance Criteria

1. The Honnyakuアプリ shall システムプロンプトに「翻訳対象テキストの前後の文脈を考慮し、代名詞や接続詞の翻訳を適切に行う」という指示を含める
2. When 複数文からなるテキストを翻訳する場合、the Honnyakuアプリ shall システムプロンプトで文間の論理的なつながりを保持するよう指示する
3. The Honnyakuアプリ shall システムプロンプトに「技術文書では、同一概念に対して一貫した訳語を使用する」という指示を含める
4. When 箇条書きやリスト構造を含むテキストを翻訳する場合、the Honnyakuアプリ shall システムプロンプトで構造を保持し、各項目の翻訳の一貫性を保つよう指示する
5. The Honnyakuアプリ shall システムプロンプトに「翻訳結果は元のテキストの意図とニュアンスを正確に反映すること」という品質基準を含める

### Requirement 4: 専門用語辞書の統合

**Objective:** ユーザーとして、頻出する専門用語が一貫して正確に翻訳されるようにしたい

#### Acceptance Criteria

1. The Honnyakuアプリ shall システムプロンプトに頻出する技術用語の翻訳ガイドライン（例: "repository" → "リポジトリ"、"commit" → "コミット"）を含める
2. When 以下の専門用語を検出した場合、the Honnyakuアプリ shall システムプロンプトで指定された訳語を使用するよう指示する:
   - "API" → "API"（訳さない）
   - "framework" → "フレームワーク"
   - "library" → "ライブラリ"
   - "module" → "モジュール"
   - "function" → "関数"
   - "variable" → "変数"
   - "interface" → "インターフェース"
   - "class" → "クラス"
   - "object" → "オブジェクト"
   - "array" → "配列"
3. The Honnyakuアプリ shall システムプロンプトにプログラミング言語固有の用語（例: React、TypeScript、Rust）を原文のまま保持する指示を含める
4. When クラウドサービス名やツール名（例: GitHub、Docker、Kubernetes）を検出した場合、the Honnyakuアプリ shall それらを原文のまま保持するようシステムプロンプトで指示する
5. The Honnyakuアプリ shall システムプロンプトに「専門用語の訳語が不明な場合は、原文を括弧付きで併記する（例: インターフェース (interface)）」という指示を含める

### Requirement 5: 自然な表現変換ガイドラインの適用

**Objective:** ユーザーとして、翻訳結果が自然で読みやすい日本語/英語になるようにしたい

#### Acceptance Criteria

1. The Honnyakuアプリ shall システムプロンプトに「翻訳結果は対象言語のネイティブスピーカーが読んで自然に感じる表現を使用すること」という指示を含める
2. When 英語から日本語へ翻訳する場合、the Honnyakuアプリ shall システムプロンプトで「です・ます調」と「だ・である調」の選択基準（技術文書では「です・ます調」を優先）を指定する
3. When 日本語から英語へ翻訳する場合、the Honnyakuアプリ shall システムプロンプトで能動態と受動態の適切な使い分けを指示する
4. The Honnyakuアプリ shall システムプロンプトに「冗長な表現や不自然な直訳を避け、簡潔で明瞭な表現を使用する」という指示を含める
5. When 丁寧語や敬語を含むテキストを翻訳する場合、the Honnyakuアプリ shall システムプロンプトで適切な丁寧度を保持するよう指示する
6. The Honnyakuアプリ shall システムプロンプトに「技術的な正確性を損なわない範囲で、読みやすさを向上させる」という品質ガイドラインを含める

### Requirement 6: 翻訳品質の測定と検証

**Objective:** アプリケーション開発者として、システムプロンプト最適化による翻訳品質の向上を客観的に測定したい

#### Acceptance Criteria

1. The Honnyakuアプリ shall 翻訳品質を評価するためのテストケースセット（最低30サンプル）を準備する
2. When テストケースを実行する場合、the Honnyakuアプリ shall 最適化前と最適化後のシステムプロンプトでそれぞれ翻訳を実行し、結果を比較する
3. The Honnyakuアプリ shall 翻訳品質スコアを以下の基準で評価する:
   - 専門用語の正確性（30点）
   - 文脈理解と一貫性（25点）
   - 自然な表現（25点）
   - 構造とフォーマットの保持（10点）
   - 技術的正確性（10点）
4. When 翻訳品質スコアを算出する場合、the Honnyakuアプリ shall 目標スコア80/100以上を達成することを確認する
5. If 翻訳品質スコアが80点未満の場合、then the Honnyakuアプリ shall システムプロンプトの改善が必要な領域を特定し、再度最適化を実施する
6. The Honnyakuアプリ shall テストケースには以下のカテゴリを含める:
   - APIドキュメント翻訳（10サンプル）
   - エラーメッセージ翻訳（5サンプル）
   - 技術ブログ記事翻訳（10サンプル）
   - コードコメント翻訳（5サンプル）

### Requirement 7: システムプロンプトの実装と統合

**Objective:** アプリケーション開発者として、最適化されたシステムプロンプトをClaude CLI翻訳機能に統合し、実運用で使用できるようにしたい

#### Acceptance Criteria

1. The Honnyakuアプリ shall 最適化されたシステムプロンプトを`src-tauri/src/llm/claude_cli.rs`の`translate_with_claude_cli`関数内で構築する
2. When システムプロンプトを構築する場合、the Honnyakuアプリ shall 翻訳元言語と翻訳先言語をパラメータとして受け取り、動的にプロンプトを生成する
3. The Honnyakuアプリ shall システムプロンプトの長さを2000トークン以内に制限し、プロンプトキャッシングの効率を最大化する
4. When Claude CLI (`claude -p`) を実行する場合、the Honnyakuアプリ shall `--system-prompt`引数で最適化されたシステムプロンプトを渡す
5. The Honnyakuアプリ shall システムプロンプトの内容を設定ファイルや環境変数で管理せず、コード内に直接埋め込む（バージョン管理の容易性のため）
6. When システムプロンプトを更新する場合、the Honnyakuアプリ shall 既存のClaude CLI翻訳機能（タイムアウト、エラーハンドリング等）に影響を与えない

### Requirement 8: 既存機能との互換性維持

**Objective:** アプリケーション開発者として、システムプロンプト最適化が既存のClaude CLI翻訳機能やOllama翻訳機能に影響を与えないことを保証したい

#### Acceptance Criteria

1. When システムプロンプトを最適化する場合、the Honnyakuアプリ shall 既存のClaude CLI翻訳機能の実装（`translate_with_claude_cli`関数）の構造を変更しない
2. The Honnyakuアプリ shall システムプロンプト最適化後も、既存の全テスト（フロントエンド9テスト、バックエンド60テスト）がパスすることを保証する
3. When Ollama翻訳方式が選択されている場合、the Honnyakuアプリ shall Ollama翻訳のシステムプロンプトには影響を与えない（Claude CLI専用の最適化）
4. The Honnyakuアプリ shall Provider選択UI、設定管理、翻訳フロー等の既存機能に変更を加えない
5. When アプリケーションアップデート時、the Honnyakuアプリ shall 既存ユーザーの翻訳体験を損なわず、自動的に最適化されたプロンプトを使用する

### Requirement 9: ドキュメントとテストの整備

**Objective:** アプリケーション開発者として、システムプロンプト最適化の内容を文書化し、品質を保証するためのテストを作成したい

#### Acceptance Criteria

1. The Honnyakuアプリ shall システムプロンプトの構造と各セクションの目的を説明するドキュメントを作成する
2. When 専門用語辞書を更新する場合、the Honnyakuアプリ shall 用語リストをドキュメント化し、追加・変更の履歴を記録する
3. The Honnyakuアプリ shall 翻訳品質テストケースをユニットテストとして実装し、CI/CDパイプラインで自動実行する
4. When システムプロンプトを変更する場合、the Honnyakuアプリ shall 変更内容と翻訳品質への影響をコミットメッセージに記録する
5. The Honnyakuアプリ shall 翻訳品質スコアの評価基準と計算方法をドキュメント化し、再現可能な形で保存する

