# タスク分割: translation-quality-improvement

## プロジェクト情報

- **機能名**: translation-quality-improvement
- **目標**: Claude CLI翻訳の品質スコアを50/100から80/100以上に向上
- **アプローチ**: システムプロンプトの最適化（3セクション構成、技術文書特化型ルール、専門用語辞書、自然な表現ガイドライン）
- **影響範囲**: `src-tauri/src/llm/claude_cli.rs`のみ（1ファイル拡張）

## 実装タスク

### Major Task 1: システムプロンプト構築ロジックの実装

- [x] 1.1 (P) build_system_prompt関数を実装し、3セクション構成のプロンプトテンプレートを生成
  - 役割定義セクション: 「あなたはプロフェッショナルな技術翻訳者です」という明確な役割を定義
  - 翻訳ルールセクション: 技術文書特化型のルール（次のタスク1.2, 1.3で詳細化）
  - 品質ガイドラインセクション: コンテキスト保持と自然な表現ガイドライン（タスク1.4で詳細化）
  - 言語方向（英→日、日→英）に応じて異なるルールセクションを構築
  - _Requirements: 1.1, 1.2, 1.4, 1.5_

- [x] 1.2 (P) 技術文書特化型翻訳ルールを実装し、プログラミング用語とコードスニペットを保持
  - プログラミング言語のキーワードや識別子を原文のまま保持するルールを追加
  - コードブロック（バッククォート3つで囲まれた部分）を翻訳しない指示を追加
  - APIエンドポイント、HTTPメソッド、ファイルパス、コマンドライン引数を原文のまま保持する指示を追加
  - 技術用語の日本語訳が複数存在する場合の一貫性ルールを追加
  - 「開発者向けドキュメントの翻訳では、技術的な正確性を最優先し、意訳よりも直訳を重視する」指示を追加
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

- [x] 1.3 (P) 専門用語辞書を統合し、10種類の基本用語の訳語ガイドラインをプロンプトに埋め込む
  - 10種類の基本用語（API, framework, library, module, function, variable, interface, class, object, array）の訳語リストをプロンプトに追加
  - プログラミング言語名（React、TypeScript、Rust等）を原文のまま保持する指示を追加
  - クラウドサービス名やツール名（GitHub、Docker、Kubernetes等）を原文のまま保持する指示を追加
  - 専門用語の訳語が不明な場合は原文を括弧付きで併記する指示を追加
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 1.4 (P) コンテキスト保持と自然な表現ガイドラインを実装
  - 「翻訳対象テキストの前後の文脈を考慮し、代名詞や接続詞の翻訳を適切に行う」指示を追加
  - 複数文からなるテキストで文間の論理的なつながりを保持するよう指示
  - 技術文書では同一概念に対して一貫した訳語を使用する指示を追加
  - 箇条書きやリスト構造を含むテキストで構造を保持し、各項目の翻訳の一貫性を保つよう指示
  - 「翻訳結果は対象言語のネイティブスピーカーが読んで自然に感じる表現を使用すること」指示を追加
  - 英→日では「です・ます調」を優先、日→英では能動態と受動態の適切な使い分けを指示
  - 「冗長な表現や不自然な直訳を避け、簡潔で明瞭な表現を使用する」指示を追加
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

- [x] 1.5 プロンプト長検証テストを実装し、2000トークン以内であることを確認
  - `test_system_prompt_token_limit`テストを作成し、英→日と日→英の両方向でプロンプトを生成
  - トークン数計測（英語: 1トークン≒4文字、日本語: 1トークン≒2文字の近似値を使用）
  - 英→日プロンプトが2000トークン以内であることをアサート
  - 日→英プロンプトが2000トークン以内であることをアサート
  - プロンプト長超過時のエラーメッセージを明確化
  - _Requirements: 1.3, 7.3_

### Major Task 2: Claude CLI翻訳機能への統合

- [x] 2.1 translate_with_claude_cli関数でbuild_system_promptを呼び出し、最適化されたプロンプトを使用
  - `translate_with_claude_cli`関数内で`build_system_prompt(source_lang, target_lang)`を呼び出す
  - 生成されたシステムプロンプトを`--system-prompt`引数に渡す
  - 既存のCLI実行フロー（タイムアウト、エラーハンドリング）は変更しない
  - 関数シグネチャは不変のまま維持
  - プロンプトキャッシング効率を維持（固定部分が自動的にキャッシュされる）
  - _Requirements: 7.1, 7.2, 7.4, 7.5, 7.6_

- [x] 2.2 既存テストがパスすることを確認し、既存機能への影響がないことを検証
  - 既存の統合テスト（`test_translate_success`, `test_translate_cli_not_found`, `test_translate_timeout`）を実行
  - 全テストがパスすることを確認
  - Ollama翻訳機能に影響がないことを確認（独立したモジュール）
  - Provider選択UI、設定管理、翻訳フローに変更がないことを確認
  - フロントエンド（9テスト）とバックエンド（60テスト）の既存テストスイート全体を実行
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

### Major Task 3: 翻訳品質テストスイートの作成

- [x] 3.1 (P) 30サンプルのテストケースセットを準備し、4カテゴリに分類
  - APIドキュメント翻訳のテストケース（10サンプル）を作成
  - エラーメッセージ翻訳のテストケース（5サンプル）を作成
  - 技術ブログ記事翻訳のテストケース（10サンプル）を作成
  - コードコメント翻訳のテストケース（5サンプル）を作成
  - 各テストケースに元テキスト、翻訳方向、カテゴリ、期待される翻訳（参考用）を含める
  - テストケースをJSON形式で`src-tauri/tests/translation_quality_test_cases.json`に保存
  - _Requirements: 6.1, 6.6_

- [x] 3.2 (P) 翻訳品質評価基準をドキュメント化し、5項目評価基準の計算方法を定義
  - `docs/translation-quality-evaluation.md`を作成
  - 専門用語の正確性（30点）の評価基準と計算方法を定義
  - 文脈理解と一貫性（25点）の評価基準と計算方法を定義
  - 自然な表現（25点）の評価基準と計算方法を定義
  - 構造とフォーマットの保持（10点）の評価基準と計算方法を定義
  - 技術的正確性（10点）の評価基準と計算方法を定義
  - サンプル評価例を各カテゴリ（APIドキュメント、エラーメッセージ等）で提供
  - _Requirements: 6.3, 6.4, 9.5_

- [x] 3.3 翻訳品質テストを実装し、目標スコア80/100以上を達成することを確認
  - `test_translation_quality_all_cases`テストを実装（`#[ignore]`付き、Claude CLI必須）
  - テストケースセット（30サンプル）を読み込み
  - 最適化されたプロンプトで各テストケースを翻訳実行
  - 5項目評価基準で品質スコアを算出（`docs/translation-quality-evaluation.md`の基準に従う）
  - 平均スコアが80/100以上であることをアサート
  - 80点未満の場合はテスト失敗とし、改善が必要な領域を特定
  - 最適化前と最適化後のシステムプロンプトで翻訳を実行し、結果を比較（オプション）
  - 品質テスト実行ガイド（`docs/translation-quality-testing-guide.md`）を作成
  - _Requirements: 6.2, 6.4, 6.5_

### Major Task 4: ドキュメントの整備

- [x] 4.1 (P) README更新
  - READMEにClaude CLI翻訳の品質向上機能を追加
  - システムプロンプトの3セクション構成（役割定義、翻訳ルール、品質ガイドライン）を説明
  - 技術文書特化型の翻訳ルール、専門用語辞書の統合、自然な表現ガイドラインを記載
  - 翻訳品質スコア50/100→80/100以上への改善を記載
  - 使用例や設定方法は変更なし（内部改善のため）
  - _Requirements: 9.1, 9.4_

- [x] 4.2 (P) 専門用語辞書をドキュメント化し、用語リストを記録
  - `docs/technical-terminology-dictionary.md`を作成
  - 10種類の基本用語（API, framework, library, module, function, variable, interface, class, object, array）の訳語リストを記録
  - プログラミング言語名、クラウドサービス名、ツール名の保持ルールを記録
  - 専門用語辞書の追加・変更の履歴を記録する方法を定義
  - 将来的な辞書拡張（50-100用語）の方針を記載
  - _Requirements: 9.2_

## タスク実行ガイダンス

### 並列実行可能なタスク

以下のタスクは並列実行可能です（`(P)` マーカー付き）:
- **Task 1.1, 1.2, 1.3, 1.4**: 独立したプロンプトセクションの実装、ファイル競合なし
- **Task 3.1, 3.2**: テストケース準備とドキュメント作成、独立した作業
- **Task 4.1, 4.2**: ドキュメント作成、独立した作業

### 依存関係

- Task 1.5 は Task 1.1 完了後に実行（`build_system_prompt`関数が必要）
- Task 2.1 は Task 1.1-1.4 完了後に実行（プロンプトテンプレート実装が必要）
- Task 2.2 は Task 2.1 完了後に実行（統合完了後にテスト）
- Task 3.3 は Task 3.1, 3.2 完了後に実行（テストケースと評価基準が必要）

### 推奨実行順序

**Phase 1**: タスク 1.1, 1.2, 1.3, 1.4 を並列実行（システムプロンプトテンプレート実装）
**Phase 2**: タスク 1.5 を実行（プロンプト長検証）
**Phase 3**: タスク 2.1 を実行（Claude CLI統合）
**Phase 4**: タスク 2.2 を実行（既存テスト検証）
**Phase 5**: タスク 3.1, 3.2, 4.1, 4.2 を並列実行（テストスイートとドキュメント作成）
**Phase 6**: タスク 3.3 を実行（翻訳品質テスト実行）

## 要件カバレッジ

| Requirement | 説明 | タスク |
|-------------|------|--------|
| 1.1, 1.2, 1.4, 1.5 | システムプロンプト構造最適化 | 1.1 |
| 1.3, 7.3 | プロンプトキャッシング | 1.5 |
| 2.1, 2.2, 2.3, 2.4, 2.5, 2.6 | 技術文書特化型翻訳ルール | 1.2 |
| 3.1, 3.2, 3.3, 3.4, 3.5 | コンテキスト保持機能 | 1.4 |
| 4.1, 4.2, 4.3, 4.4, 4.5 | 専門用語辞書統合 | 1.3 |
| 5.1, 5.2, 5.3, 5.4, 5.5, 5.6 | 自然な表現変換ガイドライン | 1.4 |
| 6.1, 6.6 | 翻訳品質測定（テストケース） | 3.1 |
| 6.2, 6.4, 6.5 | 翻訳品質測定（テスト実行） | 3.3 |
| 6.3, 6.4, 9.5 | 翻訳品質測定（評価基準） | 3.2 |
| 7.1, 7.2, 7.4, 7.5, 7.6 | システムプロンプト実装・統合 | 2.1 |
| 8.1, 8.2, 8.3, 8.4, 8.5 | 既存機能互換性維持 | 2.2 |
| 9.1, 9.4 | ドキュメント整備（プロンプト構造） | 4.1 |
| 9.2 | ドキュメント整備（専門用語辞書） | 4.2 |

**全要件カバレッジ**: 9要件（Requirement 1-9）の全43個の受け入れ基準が上記タスクで完全にカバーされています。

## テスト戦略

### 単体テスト
- `test_system_prompt_token_limit`: プロンプト長検証（Task 1.5）
- `test_build_system_prompt_en_to_ja`: 英→日プロンプト生成検証（Task 1.1）
- `test_build_system_prompt_ja_to_en`: 日→英プロンプト生成検証（Task 1.1）
- `test_terminology_dictionary_included`: 専門用語辞書の存在検証（Task 1.3）

### 統合テスト
- `test_translate_success` (既存): 翻訳成功のE2Eテスト（Task 2.2）
- `test_translate_cli_not_found` (既存): CLI未発見エラーテスト（Task 2.2）
- `test_translate_timeout` (既存): タイムアウトテスト（Task 2.2）

### 翻訳品質テスト
- `test_translation_quality_all_cases`: 30サンプルの品質評価テスト（Task 3.3）

## 見積もりサマリー

| タスク | 工数見積 |
|--------|---------|
| Task 1.1 | 2-3時間 |
| Task 1.2 | 1-2時間 |
| Task 1.3 | 1-2時間 |
| Task 1.4 | 2-3時間 |
| Task 1.5 | 1時間 |
| Task 2.1 | 1時間 |
| Task 2.2 | 1時間 |
| Task 3.1 | 2-3時間 |
| Task 3.2 | 2-3時間 |
| Task 3.3 | 2-3時間 |
| Task 4.1 | 1-2時間 |
| Task 4.2 | 1-2時間 |
| **合計** | **17-25時間（2-3日）** |

**Note**: 並列実行を活用することで、実装期間を短縮可能（理論上は1-2日で完了可能）。
