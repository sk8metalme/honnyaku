# 実装タスク: translation-summary-reply

## 概要

翻訳ポップアップに要約・返信作成機能を追加します。翻訳完了後、ユーザーは翻訳結果を即座に要約したり、元の文章への返信を生成したりできます。

## タスクリスト

### 1. バックエンド - 要約・返信生成機能の実装

Rustバックエンドにて、Ollama APIを使用した要約・返信生成のコアロジックを実装します。

- [x] 1.1 (P) 要約生成のコアロジック実装
  - 要約用プロンプトを構築する関数を実装（日本語・英語対応）
  - Ollama APIに要約リクエストを送信し、レスポンスを処理
  - 要約結果の文字数、元テキストの文字数、処理時間を含む構造体を返却
  - エラーハンドリング（接続失敗、タイムアウト、APIエラー）を既存パターンに従って実装
  - 処理時間を計測し、結果に含める
  - _Requirements: 3, 5_

- [x] 1.2 (P) 返信生成のコアロジック実装
  - 返信作成用プロンプトを構築する関数を実装（ビジネス向け丁寧な文体、日本語・英語対応）
  - Ollama APIに返信生成リクエストを送信し、レスポンスを処理
  - 返信テキスト、言語、処理時間を含む構造体を返却
  - エラーハンドリング（接続失敗、タイムアウト、APIエラー）を既存パターンに従って実装
  - 処理時間を計測し、結果に含める
  - _Requirements: 4, 5_

- [x] 1.3 Tauri IPCコマンドの登録
  - `summarize` コマンドを定義し、テキストと言語を受け取り要約結果を返す
  - `generate_reply` コマンドを定義し、テキストと言語を受け取り返信結果を返す
  - 両コマンドを `invoke_handler` に登録
  - 設定ストアから `ollamaModel` と `ollamaEndpoint` を取得
  - _Requirements: 5_

### 2. フロントエンド - 型定義とAPI統合

TypeScriptで新しい型定義を追加し、バックエンドAPIとの統合を実装します。

- [x] 2.1 (P) 要約・返信結果の型定義追加
  - 要約結果を表すインターフェース（要約テキスト、元文字数、要約文字数、処理時間）を定義
  - 返信結果を表すインターフェース（返信テキスト、言語、処理時間）を定義
  - バックエンドの型とフィールド名を一致させる（camelCaseに変換）
  - _Requirements: 5_

- [x] 2.2 useTranslationFlowフックの拡張
  - アクション状態（`idle`, `summarizing`, `generating-reply`）を管理する状態を追加
  - 要約テキスト、返信テキスト、アクションエラーを保持する状態を追加
  - 翻訳先言語（targetLanguage）を保持する状態を追加
  - 翻訳処理内で翻訳先言語を設定
  - 要約を実行する関数を実装（Tauri IPCで `summarize` を呼び出し、結果を状態に保存）
  - 返信作成を実行する関数を実装（Tauri IPCで `generate_reply` を呼び出し、結果を状態に保存）
  - 同時実行を防止するガード処理（アクション実行中は追加アクションを拒否）
  - リセット関数で要約・返信の状態もクリア
  - フックの戻り値に新しい状態と関数を追加
  - _Requirements: 3, 4, 6, 7_

### 3. UI - ボタンと結果表示エリアの実装

TranslationPopupコンポーネントに要約・返信ボタンと結果表示エリアを追加します。

- [ ] 3.1 要約・返信ボタンの追加
  - 翻訳完了状態（`state === 'completed'`）かつ翻訳結果が存在する場合にボタンを表示
  - 要約ボタン（紫色 `bg-purple-500`）を実装
  - 返信作成ボタン（緑色 `bg-green-500`）を要約ボタンの右隣に配置
  - アクション実行中（`actionState === 'summarizing'` または `'generating-reply'`）は両方のボタンを非活性化
  - 実行中のボタンにスピナーと進行状態テキスト（「要約中...」「返信作成中...」）を表示
  - 小さなスピナーコンポーネントを実装（ボタン内表示用）
  - _Requirements: 1, 2, 7_

- [ ] 3.2 要約・返信結果表示エリアの実装
  - 要約結果が存在する場合、紫色背景（`bg-purple-50 dark:bg-purple-900/30`）のエリアを表示
  - 返信結果が存在する場合、緑色背景（`bg-green-50 dark:bg-green-900/30`）のエリアを表示
  - 各エリアにラベル（「要約」「返信案」）とコピーボタンを含むヘッダーを配置
  - 結果テキストをスクロール可能な領域（要約: `max-h-48`、返信: `max-h-32`）に表示
  - コピーボタンはワンクリックでクリップボードにコピー可能にする
  - _Requirements: 3, 4, 8_

- [ ] 3.3 状態に応じたUIの切り替え
  - アクションエラーが存在する場合、エラーメッセージを赤色背景で表示
  - ポップアップ全体の最大幅（`max-w-md`）を維持し、要約・返信エリア追加後も画面外にはみ出さないことを確認
  - ダークモード対応のカラーリング（`dark:` プレフィックス）を適用
  - _Requirements: 3, 4, 8_

### 4. 統合 - 機能の結合とテスト

フロントエンドとバックエンドを結合し、エンドツーエンドで機能を検証します。

- [ ] 4.1 App.tsxでのprops接続
  - useTranslationFlowから新しい状態と関数（actionState, summaryText, replyText, actionError, summarize, generateReply）を取得
  - TranslationPopupコンポーネントに新しいpropsを渡す
  - _Requirements: 1, 2, 3, 4_

- [ ] 4.2 E2Eフロー検証
  - 日本語→英語翻訳後、要約ボタンで英語要約が生成されることを確認
  - 英語→日本語翻訳後、返信ボタンで日本語返信が生成されることを確認
  - 処理中のスピナー表示と非活性化が正しく動作することを確認
  - Ollama未起動時に適切なエラーメッセージが表示されることを確認
  - 各結果のコピーボタンが正常に機能することを確認
  - Escキーまたは閉じるボタンで全状態（翻訳、要約、返信）がリセットされることを確認
  - _Requirements: 1, 2, 3, 4, 6, 7, 8_

## 要件カバレッジマトリックス

| 要件ID | 要件名 | カバーするタスク |
|-------|--------|----------------|
| 1 | 要約ボタン表示 | 3.1, 4.1 |
| 2 | 返信作成ボタン表示 | 3.1, 4.1 |
| 3 | 要約機能の実行 | 1.1, 2.2, 3.2, 3.3, 4.1, 4.2 |
| 4 | 返信作成機能の実行 | 1.2, 2.2, 3.2, 3.3, 4.1, 4.2 |
| 5 | バックエンドAPIの追加 | 1.1, 1.2, 1.3, 2.1 |
| 6 | 状態管理とリセット | 2.2, 4.2 |
| 7 | 同時実行制御 | 2.2, 3.1, 4.2 |
| 8 | UIレイアウトと視認性 | 3.2, 3.3, 4.2 |

## 見積もり

- **総タスク数**: 4メジャータスク、9サブタスク
- **推定工数**: 5-7時間（サブタスクあたり1-3時間想定）
- **並列実行可能**: タスク1.1と1.2、タスク2.1は並列実行可能（(P)マーカー付与済み）

## 実装順序の推奨

1. **Phase 1**: タスク1（バックエンド） - 1.1と1.2を並列実行、その後1.3
2. **Phase 2**: タスク2（フロントエンド型定義） - 2.1と2.2を順次実行
3. **Phase 3**: タスク3（UI実装） - 3.1→3.2→3.3の順で実行
4. **Phase 4**: タスク4（統合） - 4.1→4.2の順で実行

## 次のステップ

タスクを承認後、以下のコマンドで実装を開始してください：

```bash
# 特定のタスクを実行
/kiro:spec-impl translation-summary-reply 1.1

# 複数タスクを実行
/kiro:spec-impl translation-summary-reply 1.1,1.2

# 全タスクを実行（非推奨：コンテキスト肥大化のため）
/kiro:spec-impl translation-summary-reply
```

**重要**: タスク間でコンテキストをクリアし、新鮮な状態で各タスクに取り組むことを推奨します。
